---
Title: ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰ã€ã‚’èª­ã‚“ã æ„Ÿæƒ³
Category:
- æŠ€è¡“æ›¸
EditURL: https://blog.hatena.ne.jp/kos0514/kos0514.hatenablog.com/atom/entry/6802418398474848853
PreviewURL: https://kos0514.hatenablog.com/draft/entry/MqV0rcO47pPgVgUWj1ookJz-QyA
Draft: true
---

ã“ã‚“ã«ã¡ã¯ã€[@kos0514](https://x.com/kos0514_dev)ã§ã™ã€‚

æœ€è¿‘ã€ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰ã€ã‚’èª­ã‚“ã ã®ã§ã€ãã®æ„Ÿæƒ³ã‚’ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

[https://www.oreilly.co.jp/books/9784814400331/:embed:cite]

# ã¯ã˜ã‚ã«

ã“ã®æœ¬ã®å°è±¡ã¨ã€ç§ã®çŠ¶æ…‹ã‚’è¨˜è¼‰ã™ã‚‹ã¨

ã“ã®æœ¬ã‚’èª­ã‚“ã ç‡ç›´ãªæ„Ÿæƒ³ã¨ã—ã¦ã¯ã€Effective OOPã€€ã®ã‚ˆã†ãªï¼ˆã“ã‚Œã¯å­˜åœ¨ã—ãªã„ã§ã™ãŒï¼‰ã€Tipsé›†ã¨ã„ã†å°è±¡ã§ã—ãŸã€‚
æœ¬æ›¸ã§ç™»å ´ã™ã‚‹è¨€è‘‰ã‚’è¦‹ã¦ã€DDDã®æ¦‚å¿µã‚’ç”¨ã„ã¦è¨˜è¼‰ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã¡ãªã¿ã«ã€DDDã®ã“ã¨ã¯ç¾åœ¨å‹‰å¼·ä¸­ãªã®ã§ã€ã¾ã ã¾ã åˆ†ã‹ã‚‰ãªã„ã“ã¨ã¯å¤šã„ã¨ã„ã£ãŸçŠ¶æ³ã§ã™ã€‚ã“ã‚Œã‹ã‚‰å‹‰å¼·ã—ã¦ã„ãã¾ã™ã€‚


# å…¨ä½“çš„ã«æ„Ÿã˜ãŸã“ã¨
å®Œå…¨ã«ç‹¬æ–­ã¨åè¦‹ã§ã™ãŒã€ã“ã®æœ¬ã‚’èª­ã‚“ã§æ„Ÿã˜ãŸå°è±¡ã¯ã€ä¸‹è¨˜ï¼“ã¤ã§ã—ãŸã€‚

ãã¡ã‚‰ã«ã¤ã„ã¦æ„Ÿæƒ³ã‚’ã¾ã¨ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## æ„Ÿã˜ãŸå°è±¡ï¼“é¸
* ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆä¸å¤‰ï¼‰ã«ã—ã¦ã­
* ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ä½¿ãŠã†
* è²¬å‹™ã‚’åˆ†é›¢ã—ã‚ˆã†

# ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆä¸å¤‰ï¼‰ã«ã—ã¦ã­
## ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«æ€§ã¨ã¯ä½•ã‹
* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¸€åº¦ä½œæˆã•ã‚ŒãŸå¾Œã€ãã®çŠ¶æ…‹ã‚’å¤‰æ›´ã§ããªã„ã¨ã„ã†ç‰¹æ€§ã§ã™ã€‚ã“ã®è¨­è¨ˆåŸå‰‡ã«ã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
  * äºˆæ¸¬å¯èƒ½ãªæŒ¯ã‚‹èˆã„: æ™‚é–“ãŒçµŒéã—ã¦ã‚‚åŒã˜çµæœã‚’è¿”ã™
  * å®‰å…¨ãªå‚ç…§å…±æœ‰: ã©ã“ã§å‚ç…§ã•ã‚Œã¦ã‚‚å‰¯ä½œç”¨ãŒãªã„
  * ä¸¦è¡Œå‡¦ç†ã§ã®å®‰å…¨æ€§: è‡ªç„¶ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ãªã‚‹
  * ãƒ†ã‚¹ãƒˆã®ç°¡æ½”æ€§: çŠ¶æ…‹å¤‰æ›´ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒãªã„


## ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã®ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«è¨­è¨ˆ

* ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼š
  * ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’finalã§å®£è¨€
  * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã®ã¿ã‚’ä½¿ç”¨ï¼ˆã‚»ãƒƒã‚¿ãƒ¼æ³¨å…¥ã‚’é¿ã‘ã‚‹ï¼‰
  * ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã®çŠ¶æ…‹ã¯å¤‰æ›´ä¸å¯èƒ½

```java
@Service
@RequiredArgsConstructor
public class TransmigrationService {

  // 1. ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’finalã§å®£è¨€
  private final TransmigratorFactory transmigratorFactory;  // finalå®£è¨€
  private final SelectWorldService selectWorldService;       // finalå®£è¨€
  private final SelectRaceService selectRaceService;         // finalå®£è¨€

  // 2. ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã®ã¿ã‚’ä½¿ç”¨ï¼ˆã‚»ãƒƒã‚¿ãƒ¼æ³¨å…¥ã‚’é¿ã‘ã‚‹ï¼‰
  // @RequiredArgsConstructorã«ã‚ˆã‚Šã€finalãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã‚’å¼·åˆ¶

  // 3. ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã®çŠ¶æ…‹ã¯å¤‰æ›´ä¸å¯èƒ½
  void startTransmigrationProcess(UserInputProvider inputProvider) {
    // ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å†…éƒ¨çŠ¶æ…‹ã‚’å¤‰æ›´ã›ãšã€ä¾å­˜é–¢ä¿‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã®ã¿
    var soulName = collectSoulName(inputProvider);
    var age = collectAge(inputProvider);
    var selectedWorld = selectWorldService.selectWorld(inputProvider);
    var selectedRace = selectRaceService.selectRace(inputProvider);

    var transmigrator = transmigratorFactory.create(soulName, age, selectedWorld, selectedRace);
    executeTransmigration(transmigrator);
  }
}
```

### ãªã‚“ã§ã€ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’finalã«ã™ã‚‹ã®ï¼Ÿ

ã“ã‚Œã‚’è¨˜è¼‰ã—ã¦ã„ã¦æ€ã„å‡ºã—ãŸã®ã§ã™ãŒã€ã¡ã‚‡ã£ã¨å‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`@Autowired`ï¼‰ã‚’å¤šç”¨ã—ã¦ã„ã¾ã—ãŸã€‚

ãã®æ™‚ã¯ã€ãã‚ŒãŒå½“ãŸã‚Šå‰ã ã¨æ€ã£ã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆè‡ªä½“ã‚‚å®Ÿæ–½ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€çŸ¥ã‚‰ãªã„ã£ã¦æ‚²ã—ã¿ã‚’æ„Ÿã˜ã¾ã—ãŸã€‚

ä¸€éƒ¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ã„ãŸã‚¯ãƒ©ã‚¹ã‚‚ã‚ã£ãŸã®ã§ã™ãŒã€å¾Œè¿°ã™ã‚‹ãƒ¢ãƒƒã‚¯ã¨ã‚¹ã‚¿ãƒ–ã‚’åˆ©ç”¨ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã¯å…¨ä¾å­˜ã—ã¦ã„ã¾ã—ãŸã€‚

#### å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆfinalãªã—ï¼‰

```java
@Service
public class BadTransmigrationService {
    private TransmigratorFactory factory;  // finalãªã—
    private SelectWorldService worldService;  // finalãªã—
    
    @Autowired
    public void setFactory(TransmigratorFactory factory) {
        this.factory = factory;
    }
    
    @Autowired 
    public void setWorldService(SelectWorldService worldService) {
        this.worldService = worldService;
    }
    
    public void processTransmigration() {
        // ã“ã®æ™‚ç‚¹ã§ factory ã‚„ worldService ãŒ null ã®å¯èƒ½æ€§
        var transmigrator = factory.create(...);  // NullPointerException!
    }
}

```

#### å®Ÿéš›ã«èµ·ã“ã‚‹å•é¡Œ
##### å•é¡Œ1: å®Ÿè¡Œæ™‚ã®NullPointerException

```java
// ãƒ†ã‚¹ãƒˆä¸­ã«å®Ÿéš›ã«èµ·ã“ã‚Šã†ã‚‹å•é¡Œ
@Test
void testProcessTransmigration() {
    var service = new BadTransmigrationService();
    // ã†ã£ã‹ã‚Š setFactory() ã‚’å‘¼ã³å¿˜ã‚Œã‚‹
    service.setWorldService(worldService);

    // å®Ÿè¡Œæ™‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
    service.processTransmigration();  // NullPointerException!
}
```

##### å•é¡Œ2: äºˆæœŸã—ãªã„ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´

```java
// æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚„è¨­å®šãƒŸã‚¹ã§ä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚Œã‚‹
@Service
public class MaliciousService {
    @Autowired
    private BadTransmigrationService badService;

    public void doSomethingBad() {
        // å®Ÿè¡Œæ™‚ã«ä¾å­˜é–¢ä¿‚ã‚’ç ´å£Šçš„ã«å¤‰æ›´
        badService.setFactory(null);  // ã‚·ã‚¹ãƒ†ãƒ ç ´ç¶»ï¼
        badService.setWorldService(new FakeWorldService());  // å½ã®å®Ÿè£…ã«å·®ã—æ›¿ãˆ
    }
}
```

#### finalã«ã‚ˆã‚‹è§£æ±º

```java
@Service
@RequiredArgsConstructor
public class GoodTransmigrationService {
    private final TransmigratorFactory factory;      // final = çµ¶å¯¾ã«å¤‰æ›´ä¸å¯èƒ½
    private final SelectWorldService worldService;   // final = çµ¶å¯¾ã«å¤‰æ›´ä¸å¯èƒ½
    
    public void processTransmigration() {
        // factory ã¨ worldService ã¯çµ¶å¯¾ã«nullã§ã¯ãªã„
        var transmigrator = factory.create(...);  // å®‰å…¨ï¼
    }
}
```

### ãªã‚“ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã®ï¼Ÿ

#### å®Ÿéš›ã«èµ·ã“ã‚‹å•é¡Œ

##### ã‚»ãƒƒã‚¿ãƒ¼æ³¨å…¥ã®å•é¡Œç‚¹

```java
@Service
public class ProblematicService {
  private UserRepository userRepository;
  private EmailService emailService;

    @Autowired
    public void setUserRepository(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
    
    @Autowired
    public void setEmailService(EmailService emailService) {
        this.emailService = emailService;
    }
    
    public void processUser(String userId) {
        // ã©ã¡ã‚‰ã‹ã®ã‚»ãƒƒã‚¿ãƒ¼ãŒå‘¼ã°ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
        var user = userRepository.findById(userId);  // ğŸ’¥ NullPointerException
        emailService.sendWelcome(user.getEmail());   // ğŸ’¥ NullPointerException
    }
}
```

##### å®Ÿéš›ã®ãƒã‚°ä¾‹

```java
// Spring ã®è¨­å®šãƒŸã‚¹ã§ç‰‡æ–¹ã®ä¾å­˜é–¢ä¿‚ãŒæ³¨å…¥ã•ã‚Œãªã„
@Configuration
public class BuggyConfig {
    @Bean
    public ProblematicService problematicService(UserRepository userRepository) {
        var service = new ProblematicService();
        service.setUserRepository(userRepository);
        
        // EmailService ã®è¨­å®šã‚’å¿˜ã‚Œã‚‹ï¼
        return service;
    }
}

// å®Ÿè¡Œæ™‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥(EmailServiceãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚ˆï¼ï¼‰
problematicService.processUser("123");  // NullPointerException!
```

#### ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã«ã‚ˆã‚‹å¼·åˆ¶

```java
@Service
@RequiredArgsConstructor
public class SafeService {
    private final UserRepository userRepository;
    private final EmailService emailService;
    
    // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã«ã‚ˆã‚Šã€ä¸¡æ–¹ã®ä¾å­˜é–¢ä¿‚ãŒå¿…é ˆ
    // ã©ã¡ã‚‰ã‹ä¸€æ–¹ã§ã‚‚æ¬ ã‘ã¦ã„ãŸã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚¨ãƒ©ãƒ¼
    
    public void processUser(String userId) {
        // çµ¶å¯¾ã«å®‰å…¨
        var user = userRepository.findById(userId);
        emailService.sendWelcome(user.getEmail());
    }
}
```

### ãªãœã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã‚’å¤‰æ›´ä¸å¯èƒ½ã«ã™ã‚‹ã®ã‹

#### å•é¡Œï¼šãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªã‚µãƒ¼ãƒ“ã‚¹ã®äºˆæ¸¬ä¸å¯èƒ½æ€§
* å•é¡Œç‚¹ï¼š
  * åŒã˜ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§ã‚‚ã€éå»ã®å‘¼ã³å‡ºã—å±¥æ­´ã«ã‚ˆã£ã¦æŒ¯ã‚‹èˆã„ãŒå¤‰ã‚ã‚‹
  * æ™‚é–“ãŒçµŒéã™ã‚‹ã¨ã€åŒã˜å…¥åŠ›ã«å¯¾ã—ã¦ç•°ãªã‚‹çµæœã‚’è¿”ã™

```java
@Service
public class MutableEmailService {
    private boolean duplicateCheckEnabled = false;
    private List<String> sentEmails = new ArrayList<>();

    public void enableDuplicateCheck() {
        this.duplicateCheckEnabled = true;  // çŠ¶æ…‹å¤‰æ›´
    }

    public void sendEmail(String to, String message) {
        if (duplicateCheckEnabled && sentEmails.contains(to)) {
            return; // é‡è¤‡é€ä¿¡ã‚’é˜²ã
        }
        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†
        sentEmails.add(to);
    }
}
```

##### äºˆæœŸã—ãªã„å‰¯ä½œç”¨
* æœ¬æ¥ã¯ã€1åº¦é€ä¿¡ã—ãŸã‚‰ã€ã‚‚ã†é€ã‚Œã¾ã›ã‚“ã‚ˆãªã®ã«ã€ãƒ•ãƒ©ã‚°å¤‰æ›´ã«ã‚ˆã‚Šé€ã‚Œãªããªã‚‹
  * â†’æŒ¯ã‚‹èˆã„ãŒé•ã„ã¾ã™ã‚ˆã­


```java
// ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã®å±é™ºæ€§
@Test
void demonstrateDanger() {
    var service = new MutableEmailService();
    
    // åˆ¥ã®ã‚¯ãƒ©ã‚¹ãŒå‹æ‰‹ã«è¨­å®šã‚’å¤‰æ›´
    service.enableDuplicateCheck();
    
    // äºˆæœŸã—ãªã„æŒ¯ã‚‹èˆã„ï¼šãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œãªã„
    service.sendEmail("user@example.com", "Welcome");
    service.sendEmail("user@example.com", "Welcome");
}
```

#### è§£æ±ºï¼šã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªã‚µãƒ¼ãƒ“ã‚¹
* åˆ©ç‚¹ï¼š
  * åŒã˜å…¥åŠ›ã«å¯¾ã—ã¦å¸¸ã«åŒã˜æŒ¯ã‚‹èˆã„ã‚’ä¿è¨¼
  * æ™‚é–“ãŒçµŒéã—ã¦ã‚‚äºˆæ¸¬å¯èƒ½

```java
@Service
@RequiredArgsConstructor
public class ImmutableEmailService {
    private final EmailClient emailClient;
    // å†…éƒ¨çŠ¶æ…‹ã‚’æŒãŸãªã„

    public EmailResult sendEmail(String to, String message) {
        // å¸¸ã«åŒã˜å‡¦ç†ã‚’å®Ÿè¡Œ
        return emailClient.send(to, message);
    }

    public EmailResult sendEmailWithDuplicateCheck(String to, String message, Set<String> sentEmails) {
        if (sentEmails.contains(to)) {
            return EmailResult.skipped("Already sent");
        }
        return sendEmail(to, message);
    }
}
```


### ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ä½¿ãŠã†
* ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã¯
  * ã‚ˆã‚Šå˜ç´”ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦ã€ã‚ˆã‚Šè¤‡é›‘ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šä¸Šã’ã‚‹æ‰‹æ³•ã§ã™ã€‚ç¶™æ‰¿ã®ä»£ã‚ã‚Šã«æ¨å¥¨ã•ã‚Œã‚‹é‡è¦ãªè¨­è¨ˆã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚
* æŒ¯ã‚‹èˆã„ã®å¤‰æ›´ã¨æ‹¡å¼µã®æŸ”è»Ÿæ€§
  * ã‚µãƒ¼ãƒ“ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æŒ¯ã‚‹èˆã„ã®ä¸€éƒ¨ã‚’ã€ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«è¨­å®šå¯èƒ½ã¾ãŸã¯äº¤æ›å¯èƒ½ã«ã§ãã¾ã™
  * æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã«æ–°ã—ã„è¦ä»¶ã‚„ç•°ãªã‚‹å‹•ä½œã‚’è¿½åŠ ã™ã‚‹éš›ã«ã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ 
* ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã®å‘ä¸Š
  * ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦åˆ†å‰²ã•ã‚ŒãŸå„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€å€‹åˆ¥ã«ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããªã‚Šã¾ã™
  * ä¾å­˜é–¢ä¿‚ã‚’æŠ½è±¡åŒ–ã—ã€ãƒ†ã‚¹ãƒˆä¸­ã«ãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ï¼ˆã‚¹ã‚¿ãƒ–ã‚„ãƒ•ã‚§ã‚¤ã‚¯ãªã©ï¼‰ã§ç½®ãæ›ãˆã‚‹ã“ã¨ã‚’å®¹æ˜“ã«ã™ã‚‹ã“ã¨ã¨é–¢é€£ã—ã¦ã„ã¾ã™

#### ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³è¨­è¨ˆ

##### å®Ÿè£…
* ã“ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è£œè¶³ã—ã¦ãŠãã¨ã€ã“ã¡ã‚‰ã¯ã€ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ ã§ã™
  * ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¨ã˜ã‚ƒã‚“ã‘ã‚“ã—ã¦ã€è²·ã£ãŸã‚‰ã‚ˆã‚Šãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®é«˜ã„ã‚‚ã®ã‚’é¸æŠã§ãã‚‹æ¨©åˆ©ã‚’ã‚‚ã‚‰ãˆã¾ã™
  * è² ã‘ãŸã‚‰ã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ä½ã„ã‚‚ã®ã—ã‹é¸ã¹ãªã„
* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä¿æŒã—ã¦ã„ã¾ã™
  * ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒå‡ºã™æ‰‹ã‚’ã€ãƒ©ãƒ³ãƒ€ãƒ ã§å‡ºã™ã‚¯ãƒ©ã‚¹ãŒå®Ÿéš›ã«ã€DIã•ã‚Œã‚‹

```java

@Component
@RequiredArgsConstructor
public class RockPaperScissorsGame {
    private final ComputerChoiceProvider computerChoiceProvider; // ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³

    public <T> T playGameAndConvertResult(...) {
        var wins = play(inputProvider, maxRounds, gameTitle, gameDescription);
        return winCountConverter.apply(wins);
    }

    private boolean playOneRound(UserInputProvider inputProvider) {
        var playerHand = getPlayerChoice(inputProvider);
        var computerHand = computerChoiceProvider.chooseHand(); // å§”è­²
        // å‹æ•—åˆ¤å®š...
    }
}

/**
 * ãƒ©ãƒ³ãƒ€ãƒ ãªã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹ã®é¸æŠã‚’æä¾›ã™ã‚‹å®Ÿè£…
 */
@Component
public class RandomComputerChoiceProvider implements ComputerChoiceProvider {
  private final Random random = new Random();

  @Override
  public RockPaperScissors chooseHand() {
    return RockPaperScissors.fromValue(random.nextInt(3) + 1);
  }
}

/**
 * ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹ã®é¸æŠã‚’æä¾›ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
public interface ComputerChoiceProvider {
  /**
   * ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹ã‚’é¸æŠã—ã¾ã™
   * @return é¸æŠã•ã‚ŒãŸæ‰‹ (RockPaperScissors)
   */
  RockPaperScissors chooseHand();
}

/**
 * ã˜ã‚ƒã‚“ã‘ã‚“ã®æ‰‹ã‚’è¡¨ã™åˆ—æŒ™å‹ã€‚
 */
@Getter
public enum RockPaperScissors {
  /**
   * ã‚°ãƒ¼
   */
  ROCK(1, "ã‚°ãƒ¼"),

  /**
   * ãƒãƒ§ã‚­
   */
  SCISSORS(2, "ãƒãƒ§ã‚­"),

  /**
   * ãƒ‘ãƒ¼
   */
  PAPER(3, "ãƒ‘ãƒ¼");

  // ã¾ã ã‚³ãƒ¼ãƒ‰ã¯ä¸‹ã«ç¶šããŒçœç•¥
}
```

##### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
* ãƒ†ã‚¹ãƒˆã§ã¯ã€ã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹ã®ã§ã€ã‚¹ã‚¿ãƒ–ã§æˆ»ã‚Šå€¤ã‚’å®šç¾©å¯èƒ½

```java
@ExtendWith(MockitoExtension.class)
class RockPaperScissorsGameTest {

  @Mock
  private ComputerChoiceProvider computerChoiceProvider; // ãƒ¢ãƒƒã‚¯åŒ–

  @InjectMocks
  private RockPaperScissorsGame rockPaperScissorsGame;

  @Test
  void playerWinsOnce_returnsConvertedResult() {
    // âœ… ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ‰‹ã‚’å®Œå…¨ã«åˆ¶å¾¡
    when(computerChoiceProvider.chooseHand()).thenReturn(SCISSORS);

    var inputProvider = new TestInputProvider()
            .addInput("1")  // ã‚°ãƒ¼é¸æŠ
            .addInput("2"); // çµ‚äº†

    // âœ… ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’æ’é™¤ã—ã¦ç¢ºå®Ÿã«ãƒ†ã‚¹ãƒˆ
    var result = rockPaperScissorsGame.playGameAndConvertResult(...);

    assertThat(result).isEqualTo(UNIQUE);
  }
}
```


### è²¬å‹™ã‚’åˆ†é›¢ã—ã‚ˆã†

#### CQSï¼ˆã‚³ãƒãƒ³ãƒ‰ã‚¯ã‚¨ãƒªåˆ†é›¢ï¼‰

##### ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚³ãƒãƒ³ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ã®åŸºæœ¬æ¦‚å¿µ
* ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆQuery Methodsï¼‰
  * ç›®çš„: 
    * æƒ…å ±ã®å–å¾—
  * ç‰¹å¾´: 
    * å‰¯ä½œç”¨ãªã—ã€ä½•åº¦å‘¼ã‚“ã§ã‚‚OKã€åè©çš„ãªåå‰
  * ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦:
    * ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—å›æ•°ã¯æ¤œè¨¼ã™ã‚‹ãª
  * ãã®ä»–:
    * å˜ä¸€ã®å‹ã®æˆ»ã‚Šå€¤ã‚’æŒã¤ã¹ã
    * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…éƒ¨ã‚’å…¬é–‹ã™ã‚‹ã‚ˆã†ãªã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã¯é¿ã‘ã‚‹ã¹ã
* ã‚³ãƒãƒ³ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆCommand Methodsï¼‰
  * ç›®çš„:
    * ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ
  * ç‰¹å¾´:
    * å‰¯ä½œç”¨ã‚ã‚Šã€å‘½ä»¤å½¢ã®åå‰ã€é€šå¸¸voidæˆ»ã‚Šå€¤
  * ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦:
    * ãƒ¡ã‚½ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚ŒãŸã‹ã€ä½•å›è¡Œã‚ã‚ŒãŸã‹ã€ã©ã®ã‚ˆã†ãªé †ç•ªã§è¡Œã‚ã‚ŒãŸã‹ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€ãƒ¢ãƒƒã‚¯ã‚„ã‚¹ãƒ‘ã‚¤ã‚’ä½¿ãŠã†
  * ãã®ä»–: 
    * å¤šãã®ã“ã¨ã‚’ã‚„ã‚‹ãª
    * ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä¾‹å¤–ã‚’æŠ•ã’ã‚‹ã¹ã


##### ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰

```java
public class Age {
    private final int value;
    
    // ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ï¼šæƒ…å ±å–å¾—ã®ã¿ã€å‰¯ä½œç”¨ãªã—
    public int getValue() {
        return value; // åè©çš„ãªåå‰ã€å˜ä¸€å‹ã®æˆ»ã‚Šå€¤
    }
}

// ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ï¼šæ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦è¿”ã™ã ã‘
public User createUser(String name, int age) {
  return User.builder()
          .name(name)
          .age(age)
          .id(UUID.randomUUID())
          .build();
}
// å‰¯ä½œç”¨ãªã—ã€ãƒ¡ãƒ¢ãƒªä¸Šã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆçµ„ã¿ç«‹ã¦ã®ã¿
```

##### ã‚³ãƒãƒ³ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰

```java
@Service
@RequiredArgsConstructor
public class EmailService {
    
    // æ˜ã‚‰ã‹ã«ã‚³ãƒãƒ³ãƒ‰ï¼šãƒ¡ãƒ¼ãƒ«é€ä¿¡
    public void sendWelcomeEmail(String email, String playerName) {
        var subject = "ç•°ä¸–ç•Œè»¢ç”Ÿå®Œäº†ã®ãŠçŸ¥ã‚‰ã›";
        var body = String.format("ã“ã‚“ã«ã¡ã¯%sã•ã‚“ï¼è»¢ç”ŸãŒå®Œäº†ã—ã¾ã—ãŸã€‚", playerName);
        
        emailSender.send(email, subject, body);  // å‰¯ä½œç”¨ï¼šãƒ¡ãƒ¼ãƒ«é€ä¿¡
        logger.info("ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡: {}", email); // å‰¯ä½œç”¨ï¼šãƒ­ã‚°å‡ºåŠ›
    }
}
```

# ãã®ä»–ã®å­¦ã³
* å®Ÿéš›ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ç”¨èªã¨ã—ã¦ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã§ãã¦ã„ãªã„ã“ã¨ãŒåˆ¤æ˜ã—ãŸã®ã§ã€æ”¹ã‚ã¦ç†è§£

## Arrange-Act-Assert
* Arrange â”€ ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆSUTã€Subject Under Testã¨ã‚‚å‘¼ã°ã‚Œã‚‹ï¼‰ã‚’ã€ã‚ã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã€‚
* Act â”€ ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã€‚
* Assert â”€ ãã®çµæœã®çŠ¶æ…‹ã«ã¤ã„ã¦ã€ä½•ã‚‰ã‹ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚

### å®Ÿè£…

```java
public class CurrencyConverter {

    private final ExchangeRateService exchangeRateService;

    public CurrencyConverter(ExchangeRateService exchangeRateService) {
        this.exchangeRateService = exchangeRateService;
    }

    public Amount convert(Amount amount, Currency from, Currency to) {
        BigDecimal rate = exchangeRateService.getRate(from.code(), to.code());
        return amount.multiply(rate);
    }
}

```

### ãƒ†ã‚¹ãƒˆ

```java
class CurrencyConverterTest {

    @Test
    void convert_shouldMultiplyAmountByExchangeRate() {
        // Arrange
        ExchangeRateService rateService = Mockito.mock(ExchangeRateService.class);
        Mockito.when(rateService.getRate("USD", "JPY")).thenReturn(new BigDecimal("150.00"));

        CurrencyConverter converter = new CurrencyConverter(rateService);
        Amount amount = new Amount(new BigDecimal("10.00"));
        Currency from = new Currency("USD");
        Currency to = new Currency("JPY");

        // Act
        Amount result = converter.convert(amount, from, to);

        // Assert
        assertEquals(new BigDecimal("1500.00"), result.value());
    }
}

```

### ãƒ¢ãƒƒã‚¯ã¨ã‚¹ã‚¿ãƒ–ã‚’ç”¨èªã¨ã—ã¦ã€ç†è§£ã—ã¦ã„ãªã‹ã£ãŸ
ä»•äº‹ã®ä¸­ã§ã¯ç„¡æ„è­˜ã«ã€ãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€å®Ÿéš›ã®ç”¨èªã¨ã—ã¦ç†è§£ã§ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚

#### âœ… ãƒ¢ãƒƒã‚¯ï¼ˆMockï¼‰ã¨ã‚¹ã‚¿ãƒ–ï¼ˆStubï¼‰ã®é•ã„
| é …ç›®         | **ã‚¹ã‚¿ãƒ–ï¼ˆStubï¼‰**                    | **ãƒ¢ãƒƒã‚¯ï¼ˆMockï¼‰**                                    |
| ---------- | -------------------------------- | ------------------------------------------------ |
| **ç›®çš„**     | æ±ºã¾ã£ãŸå€¤ã‚’è¿”ã™ï¼ˆæŒ¯ã‚‹èˆã„ã®æä¾›ï¼‰                | å‘¼ã³å‡ºã—çŠ¶æ³ã®æ¤œè¨¼ï¼ˆæŒ¯ã‚‹èˆã„ã®æ¤œè¨¼ï¼‰                               |
| **æ¤œè¨¼å¯¾è±¡**   | æˆ»ã‚Šå€¤ã®æœ‰ç„¡ã€è¨ˆç®—çµæœã®æ¤œè¨¼                   | ãƒ¡ã‚½ãƒƒãƒ‰ãŒã€Œå‘¼ã°ã‚ŒãŸã‹ã©ã†ã‹ã€ã®ç¢ºèª                               |
| **ä¸»ãªç”¨é€”**   | ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰                   | ã‚³ãƒãƒ³ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå‰¯ä½œç”¨ã‚ã‚Šï¼‰                                  |
| **ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³** | é€šå¸¸è¡Œã‚ãªã„                           | å‘¼ã³å‡ºã—å›æ•°ãƒ»å¼•æ•°ãªã©ã‚’ã‚¢ã‚µãƒ¼ãƒˆ                                 |
| **ä¾‹**      | é€šè²¨ãƒ¬ãƒ¼ãƒˆã‚’å›ºå®šå€¤ã§è¿”ã™ `ExchangeRatesStub` | `EventDispatcher` ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã‹ã‚’æ¤œè¨¼ã™ã‚‹ `MockDispatcher` |


# æœ€å¾Œã«

æµçŸ³ã«åˆæ­©çš„ã«ã™ãã‚‹ã“ã¨ã‚’æ›¸ã„ãŸæ°—ãŒã™ã‚‹ãªã¨æœ€åˆã«æ€ã£ãŸã®ã§ã™ãŒã€æ”¹ã‚ã¦æ·±å €ã‚Šã—ã¦ã¿ã‚‹ã¨ã€ç†è§£ãŒæµ…ã„ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚

ã“ã®æœ¬ã‚’èª­ã‚“ã§ã€æœ¬å½“ã«å‹‰å¼·ã«ãªã£ãŸã®ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚¯ã‚¨ãƒªåˆ†é›¢ã®è©±ã¨ã€Arrange-Act-Assertã®è©±ã§ã™ã€‚

ä»Šã€å‹‰å¼·ä¸­ã®DDDã®ä¸­ã«ã‚‚ã€ã‚³ãƒãƒ³ãƒ‰ã‚¯ã‚¨ãƒªè²¬ä»»åˆ†é›¢ã®è©±ãŒå‡ºã¦ããŸã‚Šã—ã¦ã€ã“ã®æœ¬ã‚’èª­ã‚“ã§é€šã˜ã‚‹ã¨ã“ã‚ãŒã‚ã‚Šã€èª­ã‚“ã§è‰¯ã‹ã£ãŸã¨ã„ã†æ„Ÿæƒ³ã§ã™ã€‚


æ¬¡å›ã‹ã‚‰ã€æŠ€è¡“æ›¸ã‚’èª­ã¿ãªãŒã‚‰ã€ã¾ã¨ã‚ã‚‹ã¨ç†è§£ãŒæ·±ã¾ã‚‹æ°—ãŒã™ã‚‹ã®ã§ã€ãã‚Œã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

~~ã‚ã¨ã€èª­ã¿ãªãŒã‚‰ã‚„ã‚‰ãªã„ã¨ã€ã‚ã–ã‚ã–æ™‚é–“ã‚’ä½œã£ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§è¾›ã™ãã‚‹~~